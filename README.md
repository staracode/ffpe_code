# FFPE Mutation Analysis Pipeline

A comprehensive pipeline for analyzing FFPE (Formalin-Fixed Paraffin-Embedded) tissue mutation data, including VCF processing, mutation counting, and signature analysis.

## üìã Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
- [Scripts](#scripts)
- [Output](#output)
- [Testing](#testing)
- [Example Workflow](#example-workflow)
- [Contributing](#contributing)
- [License](#license)
- [References](#references)

## üîç Overview

This pipeline processes VCF files containing mutation data from FFPE samples and performs:
- VCF format conversion and validation
- Mutation counting and analysis
- FFPE signature analysis for both repaired and unrepaired samples
- Generation of mutation matrices and visualizations

## üõ†Ô∏è Prerequisites

Before running the pipeline, ensure you have the following installed:

### System Dependencies
```bash
# Install htslib for VCF processing
brew install htslib

# Install wget for downloading reference genomes
brew install wget
```

### Python Environment
```bash
# Create and activate Python 3.10 environment
conda create -n py310env python=3.10
conda activate py310env

# Install required Python packages
conda install -c bioconda pyfaidx
conda install -c bioconda cyvcf2
conda install -c bioconda pandas
conda install -c bioconda numpy
conda install -c bioconda scipy
conda install -c bioconda matplotlib
conda install -c bioconda seaborn
conda install -c conda-forge scikit-learn
conda install -c bioconda scikit-image
```

### Download Reference Genome
```bash
# Download hg19 reference genome
wget http://hgdownload.cse.ucsc.edu/goldenPath/hg19/bigZips/hg19.fa.gz
gunzip hg19.fa.gz
```

### Optional: GDC Client Setup
```bash
# Download GDC client for TCGA data access
wget https://gdc.cancer.gov/files/public/file/gdc-client_v1.6.0_Ubuntu_x64.zip
unzip gdc-client_v1.6.0_Ubuntu_x64.zip
chmod +x gdc-client
```

## üöÄ Usage

### 1. VCF Conversion (optional)
Convert your VCF files to the required format:
```bash
python convert_vcf.py input.vcf output_adj.vcf
```

### 2. Mutation Analysis
Process VCF files to generate mutation counts:
```bash
python scripts/mutation.py input.vcf genome_files/hg19.fa output_counts.tsv
```

### 3. FFPE Signature Analysis

#### Single Sample Analysis
Run signature analysis for a unrepaired sample:
```bash
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_unrepaired/ -s sample_name -l Unrepaired
```

Run signature analysis for a single repaired sample:
```bash
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_repaired/ -s sample_name -l Repaired
```

#### Batch Processing (All Samples)
Process all samples in the mutation matrix automatically:

**For Unrepaired Samples:**
```bash
python scripts/FFPEsig_batch.py -i results/mutation_matrix.csv -l Unrepaired -o mutation_corrected_outputs_unrepaired
```

**For Repaired Samples:**
```bash
python scripts/FFPEsig_batch.py -i results/mutation_matrix.csv -l Repaired -o mutation_corrected_outputs_repaired
```

## üìÅ Scripts

### Core Analysis Scripts
- **`mutation.py`**: Main mutation counting and analysis script
- **`FFPEsig.py`**: FFPE signature analysis for single samples (repaired/unrepaired)
- **`FFPEsig_batch.py`**: Batch FFPE signature analysis for all samples in a matrix
- **`convert_vcf.py`**: VCF format conversion and validation

### Utility Scripts
- **`combine_mutation_counts.py`**: Combine multiple mutation count files
- **`create_mutation_counts_for_all_vcfs_in_directory.py`**: Batch process VCF files
- **`get_tcga.py`**: Download TCGA data
- **`vcfdownload.py`**: Download VCF files

## üìä Output

The pipeline generates several types of output:

### Mutation Counts
- Individual sample mutation count files (`.tsv` format)
- Combined mutation matrix (`mutation_matrix.csv`)

### Signature Analysis
- **Unrepaired samples**: `mutation_corrected_outputs_unrepaired/`
- **Repaired samples**: `mutation_corrected_outputs_repaired/`

### Batch Processing Output
When using `FFPEsig_batch.py`, the following files are generated for each sample:
- `{sample_id}_corrected_profile.csv` - Corrected mutation profile
- `{sample_id}_all_solutions.csv` - All optimization solutions
- `{sample_id}_before_correction.pdf` - Plot of original profile
- `{sample_id}_after_correction.pdf` - Plot of corrected profile
- `all_samples_corrected_matrix.csv` - Combined corrected matrix for all samples

### Visualizations
- Heatmaps (`heatmap.png`) generated by `heatmap.py`

## üß™ Testing

The pipeline includes comprehensive test suites to validate functionality:

### Running Tests
```bash
# Run the main test suite
python test_vcf_pipeline.py

# Run tests with specific environment
conda activate py310env
python test_vcf_pipeline.py
```

### Test Coverage
The `test_vcf_pipeline.py` file includes tests for:
- **VCF format conversion**: Validates VCF file structure and conversion
- **Mutation counting**: Tests mutation counting functionality (requires reference genome)
- **Command line interfaces**: Tests CLI functionality of all scripts
- **Complete workflow**: End-to-end pipeline testing
- **VCF validation**: Format and structure validation

### Test Requirements
- **Test data**: Located in `test_data/` directory
- **Reference genome**: `genome_files/hg19.fa` (for full mutation counting tests)
- **Dependencies**: All required Python packages (cyvcf2, pyfaidx, biopython, etc.)

### Test Results
Tests will gracefully handle missing dependencies and provide helpful error messages:
- ‚úÖ **Available modules**: Tests will run normally
- ‚ö†Ô∏è **Missing dependencies**: Tests will be skipped with installation instructions
- ‚ùå **Missing files**: Tests will be skipped with file location information

## üìù Example Workflow

Here's a complete example workflow:

```bash
# 1. Convert VCF format
python convert_vcf.py study3_FFPE-only_mutations.vcf study3_FFPE-only_mutations_adj.vcf

# 2. Generate mutation counts
python scripts/mutation.py study3_FFPE-only_mutations_adj.vcf hg19.fa study3_FFPE-only_mutations-tf.tsv

# 3. Run signature analysis (single sample)
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_unrepaired/ -s BRP_24_G_13 -l Unrepaired
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_repaired/ -s BRP_24_G_13 -l Repaired

# 4. Run batch signature analysis (all samples)
python scripts/FFPEsig_batch.py -i results/mutation_matrix.csv -l Unrepaired -o mutation_corrected_outputs_unrepaired
python scripts/FFPEsig_batch.py -i results/mutation_matrix.csv -l Repaired -o mutation_corrected_outputs_repaired
```

## ü§ù Contributing

This pipeline is designed for FFPE mutation analysis. Please ensure your input VCF files are properly formatted and contain the required mutation information.

## üìÑ License

This project is for research purposes. Please cite appropriately if used in publications.

## üìö References

### Data Sources
- [FFPE Mutation Analysis Paper](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-022-02709-8#Sec10) - Genome Biology publication on FFPE mutation analysis
- [BRP FFPE Dataset](https://figshare.com/articles/dataset/_BRP_FFPE_VCF_file_and_panel_bed/17072612) - Figshare dataset containing BRP FFPE VCF files and panel bed files

### FFPE Signature Analysis
- [FFPE Signature Paper](https://www.nature.com/articles/s41467-022-32041-5#Sec11) - Nature Communications publication on FFPE signatures
- [FFPEsig GitHub Repository](https://github.com/QingliGuo/FFPEsig) - Original FFPEsig tool implementation