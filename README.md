# FFPE Mutation Analysis Pipeline

A comprehensive pipeline for analyzing FFPE (Formalin-Fixed Paraffin-Embedded) tissue mutation data, including VCF processing, mutation counting, and signature analysis.

## üìã Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Data Preparation](#data-preparation)
- [Usage](#usage)
- [Scripts](#scripts)
- [Output](#output)

## üîç Overview

This pipeline processes VCF files containing mutation data from FFPE samples and performs:
- VCF format conversion and validation
- Mutation counting and analysis
- FFPE signature analysis for both repaired and unrepaired samples
- Generation of mutation matrices and visualizations

## üõ†Ô∏è Prerequisites

Before running the pipeline, ensure you have the following installed:

### System Dependencies
```bash
# Install htslib for VCF processing
brew install htslib

# Install wget for downloading reference genomes
brew install wget
```

### Python Environment
```bash
# Create and activate Python 3.10 environment
conda create -n py310env python=3.10
conda activate py310env

# Install required Python packages
conda install -c bioconda pyfaidx
conda install -c bioconda cyvcf2
conda install -c bioconda pandas
conda install -c bioconda numpy
conda install -c bioconda scipy
conda install -c bioconda matplotlib
conda install -c bioconda seaborn
conda install -c bioconda scikit-learn
conda install -c bioconda scikit-image
conda install -c bioconda scikit-image  
```

brew install wget

### Download Reference Genome
```bash
# Download hg19 reference genome
wget http://hgdownload.cse.ucsc.edu/goldenPath/hg19/bigZips/hg19.fa.gz
gunzip hg19.fa.gz
```

### Optional: GDC Client Setup
```bash
# Download GDC client for TCGA data access
wget https://gdc.cancer.gov/files/public/file/gdc-client_v1.6.0_Ubuntu_x64.zip
unzip gdc-client_v1.6.0_Ubuntu_x64.zip
chmod +x gdc-client
```

## üöÄ Usage

### 1. VCF Conversion (optional)
Convert your VCF files to the required format:
```bash
python convert_vcf.py input.vcf output_adj.vcf
```

### 2. Mutation Analysis
Process VCF files to generate mutation counts:
```bash
python scripts/mutation.py input.vcf hg19.fa output_counts.tsv
```

### 3. FFPE Signature Analysis
Run signature analysis for unrepaired samples:
```bash
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_unrepaired/ -s sample_name -l Unrepaired
```

Run signature analysis for repaired samples:
```bash
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_repaired/ -s sample_name -l Repaired
```

## üìÅ Scripts

### Core Analysis Scripts
- **`mutation.py`**: Main mutation counting and analysis script
- **`FFPEsig.py`**: FFPE signature analysis for repaired/unrepaired samples
- **`convert_vcf.py`**: VCF format conversion and validation

### Utility Scripts
- **`correct_vcf_header.py`**: Fix VCF header issues
- **`combine_mutation_counts.py`**: Combine multiple mutation count files
- **`create_mutation_counts_for_all_vcfs_in_directory.py`**: Batch process VCF files
- **`get_tcga.py`**: Download TCGA data
- **`vcfdownload.py`**: Download VCF files
- **`mutation_counter_from_vcf.py`**: Alternative mutation counting script

## üìä Output

The pipeline generates several types of output:

### Mutation Counts
- Individual sample mutation count files (`.tsv` format)
- Combined mutation matrix (`mutation_matrix.csv`)

### Signature Analysis
- **Unrepaired samples**: `mutation_corrected_outputs_unrepaired/`
- **Repaired samples**: `mutation_corrected_outputs_repaired/`

### Visualizations
- Heatmaps (`heatmap.png`) generated by `heatmap.py`

## üìù Example Workflow

Here's a complete example workflow:

```bash
# 1. Convert VCF format
python convert_vcf.py study3_FFPE-only_mutations.vcf study3_FFPE-only_mutations_adj.vcf

# 2. Generate mutation counts
python scripts/mutation.py study3_FFPE-only_mutations_adj.vcf hg19.fa study3_FFPE-only_mutations-tf.tsv

# 3. Run signature analysis
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_unrepaired/ -s BRP_24_G_13 -l Unrepaired
python scripts/FFPEsig.py -i mutation_matrix.csv -o mutation_corrected_outputs_repaired/ -s BRP_24_G_13 -l Repaired
```

## ü§ù Contributing

This pipeline is designed for FFPE mutation analysis. Please ensure your input VCF files are properly formatted and contain the required mutation information.

## üìÑ License

This project is for research purposes. Please cite appropriately if used in publications.